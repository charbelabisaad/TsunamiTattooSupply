@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    Layout = "_LayoutAdmin";
    ViewData["Title"] = "Sizes";
}

<partial name="SaveSize" />
<partial name="DeleteSize" />
<partial name="Rank" />

<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">@ViewData["Title"]</h1>
                </div><!-- /.col -->
            </div><!-- /.row -->
        </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->
    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">

            <div class="card">
                <div class="card-header">
                    <div class="row">
                        <div class="col-6 d-flex align-items-center"><h3 class="card-title">Sizes List</h3></div>
                        <div class="col-6 d-flex align-items-center justify-content-end">
                            <button id="btnNewSize" type="button" class="btn btn-sm btn-black"><i class="fas fa-plus"></i> Add New Size</button>
                            <button id="btnSetRankSize" type="button" class="btn btn-sm btn-primary btn-rank ml-3"><i class="fa-solid fa-arrow-down-1-9"></i> Set Rank</button>
                        </div>
                    </div>

                </div>

                <div class="card-body p-0">

                    <div class="col-sm-12 mt-3">
                        <table id="tableSizes" class="table table-striped w-100 ">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th class="d-none">Rank</th>
                                    <th style="width:100px">Show Front</th>
                                    <th style="width:50px">Status</th>
									<th class="no-export" style="width:50px">Actions</th>
                                </tr>
                            </thead>
                        </table>

                    </div>

                </div>

            </div>

        </div>
    </section>

</div>

@section Scripts {

    <script>
            $(document).ready(function () {

                var table = $('#tableSizes').DataTable({
                    processing: true,
                    responsive: true,
                    ajax: {
                        url: '@Url.Action("ListGetSizes", "Sizes")',
                            type: 'GET',
                        dataSrc: function (json) {
                        if (json && json.success === false) {
                            toastr.error(json.message || "Failed to load sizes.");
                            return [];
                        }
                        if (!json || !json.data) {
                            toastr.error("Unexpected response from server.");
                            return [];
                        }
                        return json.data;
                    }
                    },
                    dom: '<"row mb-2"<"col-md-6"f><"col-md-6 text-right"B>>t<"row mt-2"<"col-md-6"l><"col-md-6 text-right"ip>>',
                    language: {
                        search: "",
                        searchPlaceholder: "Search sizes..."
                    },
                    buttons: [
                            { extend: 'copy', className: 'btn btn-secondary btn-sm', exportOptions: { columns: ':visible:not(.no-export)' }, text: '<i class="fas fa-copy"></i> Copy' },
                            { extend: 'excel', className: 'btn btn-success btn-sm', exportOptions: { columns: ':visible:not(.no-export)' }, text: '<i class="fas fa-file-excel"></i> Excel' },
                            {
                                extend: 'pdfHtml5',
                                className: 'btn btn-danger btn-sm',
                                exportOptions: { columns: ':visible:not(.no-export)' },
                                text: '<i class="fas fa-file-pdf"></i> PDF',
                                customize: function (doc) {
                                    // Set all columns to auto width
                                    var tableBody = doc.content[1].table.body;
                                    var colCount = tableBody[0].length;

                                    // Distribute column widths evenly (100% width)
                                    var colWidths = [];
                                    for (var i = 0; i < colCount; i++) {
                                        colWidths.push('*');
                                    }
                                    doc.content[1].table.widths = colWidths;

                                    // Optional: reduce margins and font size to fit better
                                    doc.styles.tableBodyEven.alignment = 'center';
                                    doc.styles.tableBodyOdd.alignment = 'center';
                                    doc.styles.tableHeader.alignment = 'center';
                                    doc.defaultStyle.fontSize = 8;
                                    doc.pageMargins = [10, 10, 10, 10];
                                }
                            },
                            { extend: 'print', className: 'btn btn-dark btn-sm', exportOptions: { columns: ':visible:not(.no-export)' }, text: '<i class="fas fa-print"></i> Print' },
                        { text: '<i class="fas fa-sync"></i> Refresh', className: 'btn btn-primary btn-sm',
                            action: function () {
                                table.ajax.reload();
                            }
                        }
                    ],
                    columns: [
                        { 
                            data: 'description',
                            className: 'align-middle'
                        },
                        {
                            data: "rank",
                            className: "align-middle d-none"
                        },
                        {
                            data: 'showFront',
                            className: 'text-center align-items-center',
                            render: function (data) {
                                return data
                                    ? '<span class="text-success" style="font-size:1.5em"><i class="fas fa-check"></span>'
                                    : '<span class="text-danger" style="font-size:1.5em"><i class="fas fa-close"></span>';
                            }
                        },
                        { data: 'statusDescription',
                            class: 'align-middle text-center',
                            render: function (data, type, row) {
                              return `<div class="badge text-center text-white" style="background-color:#${row.statusColor}; width:100px">${row.statusDescription}</div>`;
                            }
                        },
                        {
                            data: null,
                            orderable: false,
                            searchable: false,
                            className: "no-export text-center",
                            render: function (data, type, row) {
                                return `
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light" type="button" data-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item btnEditSize" style="cursor:pointer" 
                                    data-id="${row.id}"
                                    data-description="${row.description}"
                                    data-showfront="${row.showFront}"
                                    data-statusid="${row.statusID}">
                                        <i class="fas fa-edit"></i> Edit
                                    </a>
                                        <a class="dropdown-item btnDeleteSize" style="cursor:pointer" data-id="${row.id}">
                                        <i class="fas fa-trash"></i> Delete
                                    </a>
                                </div>
                            </div>
                                `;
                            }
                        }
                    ],
                    order: [[2,"asc"]]
                });

                // place export buttons next to search bar
                //table.buttons().container().appendTo('#tableSizes_wrapper .col-md-6:eq(1)');

                var $filter = $('#tableSizes_filter');

                $filter.css("position", "relative");

                // Insert FA icons

                // $filter.append('<i class="fas fa-times" id="clearSearch"></i>');

                // Toggle X on typing
                // $('#tableSizes_filter input').on("input", function () {
                //     if ($(this).val().length > 0) {
                //         $('#clearSearch').show();
                //     } else {
                //         $('#clearSearch').hide();
                //     }
                // });

                // Clear on X click
                // $('#clearSearch').on("click", function () {
                //     $('#tableSizes_filter input').val('');
                //     table.search('').draw();
                //     $(this).hide();
                // });

                const btnNewSize = document.getElementById("btnNewSize");

                btnNewSize.addEventListener("click", function () {

                    const modalEl = document.getElementById("saveSizeModal");
                    const modal = new bootstrap.Modal(modalEl);

                    $("#modalSizeTitle").text('Create New Size');

                    $("#SizeID").val(0);

                    $("#SizeDescription").val('');

                    $("#SizeShowFrontToggle").prop("checked", true);
                    $("#SizeShowFront").val(1);

                    $("#SizeStatusID").val('A');
                    $("#SizeStatusToggle").prop("checked", true);

                    $("#SizeStatusLabel").text("Active");

                    $("#SizeDescriptionMessage").text('');

                    $("#SizeDescription").removeClass('border-danger');

                    modal.show();

                    $(modalEl).on('shown.bs.modal', function () {

                        $("#SizeDescription").focus();

                    });

                });

                $(document).on('click', '.btnEditSize', function(){

                    $("#modalSizeTitle").text('Modify Size');

                    const SizeID = $(this).data('id');
                    const SizeDescription = $(this).data('description');
                    const ShowFront = $(this).data('showfront') === true || $(this).data('showfront') === 1;
                    const SizeStatusID = $(this).data('statusid');
                    const modalEl = document.getElementById("saveSizeModal");
                    const modal = new bootstrap.Modal(modalEl);

                    $("#SizeID").val(SizeID);
                    $("#SizeDescription").val(SizeDescription);

                    $("#SizeShowFrontToggle").prop("checked", ShowFront);
                    $("#SizeShowFront").val(ShowFront ? 1 : 0);

                    $("#SizeStatusID").val(SizeStatusID);

                    $("#DescriptionMessage").text('');

                    $("#SizeDescription").removeClass('border-danger');

                    $("#SizeStatusToggle").prop("checked", SizeStatusID == 'A' ? true : false);
                    $("#SizeStatusLabel").text(SizeStatusID == 'A' ? 'Active' : 'Inactive');

                    modal.show()

                    $(modalEl).on('shown.bs.modal', function () {

                        $("#SizeDescription").focus();

                    });

                });

            // Show modal when Delete button clicked
            $(document).on("click", ".btnDeleteSize", function (e) {
                  e.preventDefault();

                  const sizeId = $(this).data("id");
                    $("#deletedSizeId").val(sizeId);

                  const sizedescription = $(this).closest("tr").find("td:first").text();

                  $("#deleteSizeMessage").html(
                    `Are you sure you want to delete <strong>${sizedescription}</strong>?`
                  );

                  $("#deleteSizeModal").modal("show");
                });

                 $(document).on('click', '#btnSetRankSize', function () {

                    const $rankSelect = $('#rankSelect');

                    $rankSelect.empty();

                    var type = "SZ";

                    $("#rankMode").val(type)

                    $.ajax({
                        url: '@Url.Action("ListGetSizes", "Sizes")',
                        type: 'GET',
                        data: { "TypeID": type },
                        success: function (res) {

                            if (!res.success) {
                                toastr.error(res.message || 'Failed to load sizes');
                                return;
                            }

                            // sort by Rank (safe)
                            res.data.sort((a, b) => a.rank - b.rank);

                            $.each(res.data, function (index, item) {
                                $rankSelect.append(
                                    `<option value="${item.id}">
                                        ${index + 1}. ${item.description}
                                    </option>`
                                );
                            });

                            $('#rankModal').modal('show');
                        },
                        error: function () {
                            toastr.error('Server error while loading sizes');
                        }
                    });

                });

        });

    </script>
}







