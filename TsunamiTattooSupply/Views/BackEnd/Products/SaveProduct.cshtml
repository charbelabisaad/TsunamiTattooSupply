
<style>

	.color-images-scroll {
		display: flex;
		flex-wrap: nowrap;
		gap: 12px;
		overflow-x: auto;
		overflow-y: hidden;
		width: 100%;
		padding-bottom: 6px;
	}

		/* 🔥 THIS IS THE MAGIC */
		.color-images-scroll .inline-block {
			flex: 0 0 auto;
			min-width: 220px;
		}

		/* smooth scroll */
		.color-images-scroll {
			scroll-behavior: smooth;
		}

		/* scrollbar style */
		.color-images-scroll::-webkit-scrollbar {
			height: 6px;
		}

		.color-images-scroll::-webkit-scrollbar-thumb {
			background: #c1c1c1;
			border-radius: 10px;
		}

		.color-images-scroll::-webkit-scrollbar-track {
			background: transparent;
		}
	/* ---------- IMAGE ITEM ---------- */
	.color-image-item {
		position: relative;
		overflow: hidden;
		border-radius: 6px;
	}

	/* ---------- OVERLAY ---------- */
	.color-image-item .image-overlay {
		position: absolute;
		inset: 0;
		background: rgba(0,0,0,0.55);
		opacity: 0;
		visibility: hidden;
		transition: all 0.25s ease;
	}

	/* ---------- SHOW ON HOVER ---------- */
	.color-image-item:hover .image-overlay {
		opacity: 1;
		visibility: visible;
	}

	.image-overlay {
		z-index: 10;
	}

	.color-image-input {
		z-index: 1;
	}

	.modal-loader {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(255,255,255,0.75);
		display: flex;
		align-items: center;
		justify-content: center;
		z-index: 1055;
	}

	.loader-content {
		text-align: center;
	}
	

</style>

<div class="modal fade" id="imageProductViewModal" tabindex="-1" aria-hidden="true" style="z-index:2000">
	<div class="modal-dialog modal-dialog-centered modal-xl">
		<div class="modal-content bg-transparent border-0">
			<div class="modal-body d-flex justify-content-center align-products-center p-0" style="background: rgba(0,0,0,0.9); border-radius: 10px;">
				<img id="imageProductViewModalImg"
				src=""
				class="img-fluid rounded shadow-lg"
				style="object-fit: contain; border-radius: 10px;" />

				<!-- Close Button -->
				<button type="button"
				class="btn position-absolute top-0 end-0 m-3"
				data-bs-dismiss="modal"
				aria-label="Close"
				style="background: rgba(0,0,0,0.6); border-radius: 50%; width: 45px; height: 45px;">
					<i class="fas fa-times text-white fs-4"></i>
				</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade fullmodal-right" id="saveProductModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg" role="document">



        <div class="modal-content" style="position:relative">


			<div class="modal-header">
				<h5 id="modalProductTitle" class="modal-title">Create New Product</h5>
				<button id="btnCloseProduct" type="button" class="btn-close border-0" data-bs-dismiss="modal"><i class="fas fa-close"></i></button>
			</div>

			<!-- Form -->
			<form id="productForm" method="post" enctype="multipart/form-data" class="d-flex flex-column flex-grow-1">

				@Html.AntiForgeryToken()

				<div class="modal-body flex-grow-1">

					<input id="ProductID" name="ProductID" type="hidden" value="0" />

					<div class="row">

						<div class="col-12 col-md-12">



						</div>

					</div>

					<div id="productIntialInfo" class="card">

						<div class="card-header font-weight-bold">Initial Information</div>

						<div class="card-body">

							<div class="row">

								<!-- CODE -->
								<div class="col-12 col-md-2 mb-3">
									<label class="form-label">Code</label>
									<input id="ProductCode" class="form-control" name="ProductCode" placeholder="Fill Code" />
									<div id="ProductCodeMessage" class="text-danger fw-normal"></div>
								</div>

								<!-- NAME -->
								<div class="col-12 col-md-4 mb-3">
									<label class="form-label">Name</label>
									<input id="ProductName" class="form-control" name="ProductName" placeholder="Fill Name" />
									<div id="ProductNameMessage" class="text-danger fw-normal"></div>
								</div>

								<!-- GROUP -->
								<div class="col-12 col-md-2 mb-3">
									<label class="form-label">Group Type</label>
									<select id="ProductGroupType" name="ProductGroupType" class="form-control">

										@foreach (var obj in Model.groupTypes)
										{
											<option value="@obj.ID">@obj.Description</option>
										}

									</select>
								</div>

								<div class="col-12 col-md-4 mb-3">
									<div>
										<div class="row">
											<div class="col-6">
												<label class="form-label">Group</label>
											</div>
											<div class="col-6 text-right">

												<div class="custom-control custom-switch">
													<input type="checkbox" class="custom-control-input" id="ProductStatusToggle" name="ProductStatusToggle" checked />
													<label class="custom-control-label" for="ProductStatusToggle" id="ProductStatusLabel">
														Active
													</label>
													<input type="hidden" id="ProductStatusID" name="ProductStatusID" value="A" />
												</div>

											</div>
										</div>
									</div>
									<div>
										<select id="ProductGroup" name="ProductGroup" class="form-control">
											<option value="">-- Select Group --</option>
										</select>
									</div>
								</div>

							</div>
							<div class="row">
								<!-- DESCRIPTION -->
								<div class="col-12 col-md-12 mb-3">
									<label class="form-label">Description</label>
									<textarea id="ProductDescription" class="form-control" name="ProductDescription" style="height:100px" placeholder="Fill Description"></textarea>
									<div id="ProductDescriptionMessage" class="text-danger fw-normal"></div>
								</div>

							</div>
							<div class="row">

								<!-- CATEGORY (single selection) -->
								<div class="col-12 col-md-4 mb-3">
									<label class="form-label">Category</label>
									<select id="ProductCategory" class="form-control" name="ProductCategory">

										@foreach (var obj in Model.categories)
										{
											<option value="@obj.ID">@obj.Description</option>
										}


									</select>
									<div id="ProductCategoryMessage" class="text-danger fw-normal"></div>
								</div>

								<!-- SUBCATEGORY (multiple selection) -->
								<div class="col-12 col-md-4 mb-3">
									<div>
										<label class="form-label">Sub Categories</label>
										<select id="ProductSubCategory" name="ProductSubCategory[]" class="form-control selectpicker bg-white" style="background-color:#ffffff !important" multiple data-live-search="true" data-actions-box="true">
											<!-- Options loaded dynamically -->
										</select>
										<div id="ProductSubCategoryMessage" class="text-danger fw-normal"></div>
									</div>
									<div id="SubCategoryTags" class="mt-2 d-flex flex-wrap gap-2"></div>
								</div>

								<div class="col-12 col-md-4 mb-3"> 
									<div> 
                                        <label id="ProductSpecsLabel" class="form-label">Specs</label>
                                        <select id="ProductSpecs" name="ProductSpecs[]" class="form-control selectpicker bg-white" style="background-color:#ffffff !important" multiple data-live-search="true" data-actions-box="true">  
										 
											@foreach(var obj in Model.specs){
												<option value="@obj.ID">@obj.Description</option>
											}

										</select> 
								  		<div id="ProductSpecsMessage" class="text-danger fw-normal"></div> 
								  	</div> 
								  </div>

							</div>
							<div class="row">

								<!-- UNIT -->
								<div class="col-12 col-md-3">
									<label class="form-label">Unit</label>
									<select id="ProductUnit" name="ProductUnit" class="form-control">

										@foreach (var obj in Model.units)
										{
											<option value="@obj.ID">@obj.ShortDescription - @obj.LongDescription</option>
										}

									</select>
								</div>

								<!-- New Arrival -->
								<div class="col-12 col-md-3">

									<div class="row">
										<div class="col-6">
											<label class="form-label">Expiry Date</label>
										</div>
										<div class="col-6 text-right">
											<div class="custom-control custom-switch">
												<input type="checkbox" class="custom-control-input" id="ProductNewArrival" name="ProductNewArrival" />
												<label class="custom-control-label" for="ProductNewArrival">New Arrival</label>
											</div>
										</div>
									</div>

									<div class="row">
										<!-- Expiry Date -->
										<div class="col-12">
											<input type="text" id="ProductExpiryDate" class="form-control" name="ProductExpiryDate" placeholder="Select date" />
										</div>
									</div>

								</div>

								<div class="col-12 col-md-3">

									<div class="row">
										<div class="col-6">
											<label class="form-label">Warranty Months</label>
										</div>
										<div class="col-6 text-right">
											<!-- WARRANTY -->
											<div class="custom-control custom-switch">
												<input type="checkbox" class="custom-control-input" id="ProductWarranty" name="ProductWarranty" />
												<label class="custom-control-label" for="ProductWarranty">Warranty</label>
											</div>
										</div>
									</div>

									<div class="row">
										<!-- WARRANTY MONTHS -->
										<div class="col-12">
											<input id="ProductWarrantyMonths" type="number" class="form-control" name="ProductWarrantyMonths" placeholder="0" />
										</div>
									</div>

								</div>

								<div class="col-12 col-md-3 text-right">

									<!-- VAT -->
									<div class="d-inline-block text-left">
										<div class="custom-control custom-switch mt-2">
											<input type="checkbox" class="custom-control-input" id="ProductVAT" name="ProductVAT">
											<label class="custom-control-label" for="ProductVAT">VAT</label>
										</div>
										<div class="custom-control custom-switch mt-2">
											<input type="checkbox" class="custom-control-input" id="ProductFeature" name="ProductFeature">
											<label class="custom-control-label" for="ProductFeature">Feature</label>
										</div>
									</div>

								</div>

							</div>
							 
							<br /> <br />

							<!-- TABS NAV -->
							<ul class="nav nav-tabs tabs-line mb-3" role="tablist">
								<li class="nav-item">
									<a class="nav-link active" data-toggle="tab" href="#tabSizes">
										Sizes
									</a>
								</li>
								<li class="nav-item">
									<a class="nav-link" data-toggle="tab" href="#tabColors">
										Colors
									</a>
								</li>
							</ul>

							<!-- TABS CONTENT -->
							<div class="tab-content">

								<!-- ================= SIZES TAB ================= -->
								<div class="tab-pane fade show active" id="tabSizes" role="tabpanel">

									<div class="row">

										<div class="col-12 col-md-6">
											<label class="form-label">Type</label>

											<div class="row align-items-center">

												<div class="col-12 col-md-11">

													<select id="ProductTypes" name="ProductTypes"
															class="form-control selectpicker" 
															multiple
															data-live-search="true"
															data-actions-box="true">
														@foreach (var obj in Model.productTypes)
														{
															<option value="@obj.ID">@obj.Description</option>
														}
													</select>

												</div> 
											</div>
										</div>

                                    </div>

									<div class="row mt-2">

                                        <div id="productDetailsTabsContainer" class="col-12"></div>

									</div>

                                  
										
										@* <div class="col-12 col-md-3"> *@
										@* 	<label class="form-label">Details</label> *@

										@* 	<div class="row align-items-center"> *@

										@* 		<div class="col-12 col-md-11"> *@

										@* 			<select id="ProductDetails" name="ProductDetails" *@
										@* 					class="form-control selectpicker" *@
										@* 					data-live-search="true" *@
										@* 					data-actions-box="true"> *@
										@* 				@foreach (var obj in Model.productDetails) *@
										@* 				{ *@
										@* 					<option value="@obj.ID">@obj.Description</option> *@
										@* 				} *@
										@* 			</select> *@

										@* 		</div> *@
										@* 	</div> *@
										@* </div> *@

										@* <div class="col-12 col-md-4"> *@
										@* 	<label class="form-label">Sizes</label> *@

										@* 	<div class="row align-items-center"> *@

										@* 		<div class="col-12 col-md-12"> *@
													 
										@* 		<select id="ProductSizes" name="ProductSizes" *@
										@* 			class="form-control selectpicker" *@
										@* 			multiple *@
										@* 			data-live-search="true" *@
										@* 			data-actions-box="true"> *@
										@* 				@foreach (var obj in Model.sizes) *@
										@* 				{ *@
										@* 					<option value="@obj.ID">@obj.Description</option> *@
										@* 				} *@
										@* 		</select>  *@

										@* 		</div> *@

										@* 		@* <div class="col-12 col-md-1"> *@ 
										@* 		@* 	<button id="btnNewSize" type="button" name="NewSize" class="btn btn-sm btn-primary w-100"><i class="fas fa-file"></i> New</button> *@
										@* 		@* </div> *@
                                              
										@* 	</div> *@

                                           

          @*                                   <div id="SizeEntry" class="row mt-1 align-items-center border border-1 p-3" style="display:none"> *@

										@* 		<div class="col-12 col-md-10"> *@

										@* 			<input id="txtSizeDescription" type="text" class="form-control" placeholder="Fill Size Description" /> *@

										@* 		</div> *@

										@* 		<div class="col-12 col-md-1"> *@

										@* 			<button id="btnCancelSize" type="button" name="CancelSize" class="btn btn-sm btn-outline-secondary w-100"><i class="fas fa-ban"></i> Cancel</button> *@

										@* 		</div> *@

										@* 		<div class="col-12 col-md-1"> *@

										@* 			<button id="btnCreateSize" type="button" name="CreateSize" class="btn btn-sm btn-outline-primary w-100"> *@
										@* 				<span class="spinner-border spinner-border-sm d-none" *@
										@* 					  id="btnCreateSizeSpinner" *@
										@* 					  role="status" *@
										@* 					  aria-hidden="true"></span> *@
										@* 				<i class="fas fa-plus"></i> Create</button> *@

										@* 		</div> *@

										@* 	</div> *@

										@* </div> *@

										@* <div class="col-12 col-md-2"> *@

										@* 	<label class="form-label">&nbsp;</label> *@

										@* 	<div class="row align-items-center"> *@

										@* 		<div class="col-12 col-md-12"> *@

										@* 			<button id="btnAddSize" type="button" name="AddSize" class="btn btn-sm btn-primary h-100 w-100"><i class="fas fa-plus"></i> Add</button> *@

										@* 		</div> *@

										@* 	</div> *@

										@* </div> *@

									
									  
									<div class="row mt-3">

										<div id="SizeVariationsContainer" class="col-12"></div>

									</div>

								</div>

								<!-- ================= COLORS TAB ================= -->
							 
								<div class="tab-pane fade" id="tabColors" role="tabpanel">

									<div class="row">
										<div class="col-12">

											<label class="form-label">Colors</label>
											
											<div class="row p-3">

												<div class="col-12 col-md-11">
													<select id="ProductColors"
															class="form-control selectpicker"
															name="ProductColors[]"
															multiple
															data-live-search="true"
															data-actions-box="true">
														@foreach (var obj in Model.colors)
														{
															<option value="@obj.ID"
																	data-name="@obj.Name"
																	data-code="@obj.Code"
																	data-content='
																	<span style="
																		display:inline-block;
																		width:14px;
																		height:14px;
																		background-color:#@obj.Code;
																		border:1px solid #ccc;
																		margin-right:6px;
																		vertical-align:middle;">
																	</span>
																	<span>@obj.Name</span>
																	'>
																	@obj.Name
															</option>
														}
													</select>
													 
													<div id="ProductColorsMessage" class="text-danger fw-normal"></div>

												</div>

												<div class="col-12 col-md-1">
													<button id="btnNewColor" type="button" name="NewColor" class="btn btn-sm btn-primary w-100 d-none"><i class="fas fa-file"></i> New</button>
												</div>

											</div>


											<div id="ColorEntry" class="row mt-2 border border-1 p-3" style="display:none">
												 
												<div class="col-12">
													 
													<div class="row align-items-center mb-3">

														<input id="ColorID" type="hidden" value="0" />


														<!-- 🔹 Label -->
														<div class="col-12 col-md-2 d-flex align-items-center">
															<label for="ColorName" class="form-label mb-0">Name</label>
														</div>

														<!-- 🔹 Input -->
														<div class="col-12 col-md-8 d-flex align-items-center">
															<div class="w-100">
																<input type="text" class="form-control" id="ColorName" placeholder="Fill Name" />
																<div id="ColorNameMessage" class="text-danger fw-normal"></div>
															</div>
														</div>

														<!-- 🔹 Status Toggle -->
														<div class="col-12 col-md-2 d-flex align-items-center justify-content-md-start">
															<div class="custom-control custom-switch m-0">
																<input type="checkbox" class="custom-control-input" id="ColorStatusToggle" checked>
																<label class="custom-control-label" for="ColorStatusToggle" id="ColorStatusLabel">Active</label>
																<input type="hidden" id="ColorStatusID" name="ColorStatusID" value="A">
															</div>
														</div>
													</div>

													<div class="row align-items-center mb-3">

														<!-- 🔹 Label -->
														<div class="col-12 col-md-2 d-flex align-items-center">
															<label for="ColorCode" class="form-label mb-0">Code</label>
														</div>

														<div class="col-12 col-md-8 d-flex align-items-center">

															<div class="row w-100">

																<div class="col-12 col-md-8">

																	<!-- Color picker -->
																	<input type="color"
																		   id="ColorPicker"
																		   class="form-control"
																		   value="#915555" />

																</div>

																<div class="col-12 col-md-4">

																	<!-- Read-only HEX -->
																	<input type="text"
																		   id="ColorCode"
																		   class="form-control"
																		   readonly />


																</div>

																<div id="ColorCodeMessage" class="text-danger fw-normal"></div>
															</div>
														</div>
														 
														<!-- 🔹 Status Toggle -->
														<div class="col-12 col-md-2 d-flex align-items-center justify-content-md-start">
															<div class="custom-control custom-switch m-0">
																<input type="checkbox" class="custom-control-input" id="ColorIsCustomToggle">
																<label class="custom-control-label" for="ColorIsCustomToggle" id="ColorIsCustomLabel">Is Custom</label>
															</div>
														</div>
													</div>

													<div class="row align-items-center mb-3">
														
														<div class="col-12 col-md-10"></div>

														<div class="col-12 col-md-1">

															<button id="btnCancelColor" type="button" name="CancelSize" class="btn btn-sm btn-outline-secondary w-100"><i class="fas fa-ban"></i> Cancel</button>

														</div>

														<div class="col-12 col-md-1">

															<button id="btnCreateColor" type="button" name="CreateColor" class="btn btn-sm btn-outline-primary w-100">
																<span class="spinner-border spinner-border-sm d-none"
																	  id="btnCreateColorSpinner"
																	  role="status"
																	  aria-hidden="true"></span>
																<i class="fas fa-plus"></i> Create
																</button>

														</div>
														 
													</div>

												</div>
												 
											</div>


										</div>

									</div>

									<!-- 🔥 Dynamic color cards -->
									<div class="row mt-3">
										<div id="ColorVariationsContainer" class="col-12"></div>
									</div>

								</div>


							</div>

						</div>
						 
						<div class="card-footer text-right bg-white border-top">

							<button id="btnSaveProductInitialInfo" type="button" class="btn btn-primary" style="width:100px">
								<span class="spinner-border spinner-border-sm d-none" id="btnSaveProductInitialInfoSpinner" role="status" aria-hidden="true"></span>
								<i class="fas fa-save"></i> Save
							</button>

						</div>

					</div>

					<div id="productDetails" class="row d-none">

						<div class="col-12 col-md-6">

							<div id="productPrice" class="card"> 

					 			<div class="card-header font-weight-bold">Price</div> 

								<div class="card-body">

					 				 <div id="ProductSizesPrices" class="p-3" style="height:500px; overflow-x: hidden; overflow-y: auto"></div>

				 				</div>

                                <div class="card-footer bg-white border-top text-right">

                                    <button id="btnSaveProductPrice" type="button" class="btn btn-primary" style="width:100px">
                                        <span class="spinner-border spinner-border-sm d-none" id="btnSaveProductPriceSpinner" role="status" aria-hidden="true"></span>
                                        <i class="fas fa-save"></i> Save
                                    </button>

                                </div>

							 </div>

						</div>

						<div class="col-12 col-md-6">

							<div id="productStock" class="card">

								<div class="card-header font-weight-bold">Stock</div>

								<div class="card-body">

									 <div id="ProductStock" class="p-3" style="height: 500px; overflow-x:hidden; overflow-y:auto;"></div>

								</div>

								<div class="card-footer bg-white border-top text-right">

									<button id="btnSaveProductStock" type="button" class="btn btn-primary" style="width:100px">
										<span class="spinner-border spinner-border-sm d-none" id="btnSaveProductStockSpinner" role="status" aria-hidden="true"></span>
										<i class="fas fa-save"></i> Save
									</button>

								</div>

							</div>
					  
						</div>

					</div>

                </div>

				 
                @* <!-- ✅ Fixed footer --> *@
                @* <div class="modal-footer"> *@
                @*     <button id="btnCancelProduct" type="button" class="btn btn-secondary" data-bs-dismiss="modal"> *@
                @*         <i class="fas fa-ban"></i> Cancel *@
                @*     </button> *@
                @* </div> *@

            </form>

            <div id="modalLoader" class="modal-loader d-none">
                <div class="loader-content text-center">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="mt-2 font-weight-bold">Loading...</div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>

	document.addEventListener('DOMContentLoaded', function () {

		const currencies = [
		@foreach (var obj in Model.currencies)
		{
			<text>
					{
						id: @obj.ID,
						code: "@obj.Code"
					},
			</text>
		}
		];

		const currencyConversion = {
			operator: '@Model.currencyconversion.Operator',
			rate: @Model.currencyconversion.Rate
		};

	 


			// Picker → HEX
			$('#ColorPicker').on('input change', function () {
				$('#ColorCode').val(this.value.toUpperCase());
			});

			// Is Custom toggle
			$('#ColorIsCustomToggle').on('change', function () {

				if (this.checked) {
					// Custom color → no picker
					$('#ColorPicker').prop('disabled', true);
					$('#ColorCode').val('');
					$('#ColorIsCustomLabel').text('Is Custom');
				} else {
					// System color → enable picker
					$('#ColorPicker').prop('disabled', false);
					syncColorCode();
				}
			});

			function syncColorCode() {
				let color = $('#ColorPicker').val();
				$('#ColorCode').val(color ? color.toUpperCase() : '');
			}


			$('#ProductSizes').on('changed.bs.select', function () {

			//if (isEditLoading) return;
		   
			let container = $('#SizeVariationsContainer');

			// Selected size IDs (as strings)
			let selectedIds = $(this).val() || [];
			let selectedSet = new Set(selectedIds.map(String));

			// ==========================
			// 1️⃣ REMOVE unselected cards
			// ==========================
			container.find('.variation-card').each(function () {
				let sizeId = String($(this).data('size-id'));
				if (!selectedSet.has(sizeId)) {
					$(this).remove();
				}
			});

			// ==========================
			// 2️⃣ ADD missing cards
			// ==========================
			selectedIds.forEach(sizeId => {
			 
				if (container.find(`.variation-card[data-size-id="${sizeId}"]`).length)
					return;

				let sizeText = $('#ProductSizes option[value="' + sizeId + '"]').text();

				let currencyHtml = '';

				currencies.forEach(c => {

					let isDefault = c.code === 'USD';

					currencyHtml += `
						<div class="col-12 col-md-2 mb-2">
							<label>Price ${c.code}</label>
							<input type="number"
								   step="0.01"
								   class="form-control ${isDefault ? 'default-price' : 'second-price'}"
								   data-currency-id="${c.id}"
								   name="Variations[${sizeId}].Prices[${c.id}]"
								   ${isDefault ? '' : 'readonly'}
								   value="0">
						</div>

						<div class="col-12 col-md-2 mb-2">
							<label>Price Net ${c.code}</label>
							<input type="number"
								   step="0.01"
								   class="form-control ${isDefault ? 'default-price-net' : 'second-price-net'}"
								   data-currency-id="${c.id}"
								   name="Variations[${sizeId}].PricesNet[${c.id}]"
								   ${isDefault ? '' : 'readonly'}
								   value="0">
						</div>
					`;
				});

				let html = `
					<div class="variation-card" data-size-id="${sizeId}">
						<div class="variation-header p-2 d-flex justify-content-between align-items-center" style="background-color:#ecebeb">
							<span>${sizeText}</span>

							<div class="custom-control custom-switch">
								<input type="checkbox"
									   class="custom-control-input"
									   id="SizeStatus_${sizeId}"
									   name="Variations[${sizeId}].IsActive"
									   checked>
								<label class="custom-control-label" for="SizeStatus_${sizeId}">
									Active
								</label>
							</div>
						</div>

						<div class="variation-body p-2">

							<div class="row">
								<div class="col-12 col-md-2 mb-2">
									<label>Sale %</label>
									<input type="number"
										   step="0.01"
										   class="form-control sale-input"
										   name="Variations[${sizeId}].Sale"
										   value="0">
								</div>
 
							</div>

							<div class="row mt-3">
								${currencyHtml}
							</div>

						</div>
					</div>
				`;

				container.append(html);
			});
		});



			// ✅ Default price → auto-calc second prices
			$(document).on('input', '.sale-input, .raise-input, .default-price', function () {

				let card = $(this).closest('.variation-card');

				let price = parseFloat(card.find('.default-price').val()) || 0;
				let sale  = parseFloat(card.find('.sale-input').val()) || 0;
				let raise = parseFloat(card.find('.raise-input').val()) || 0;

				let net = price + raise - sale;

				// Set NET price (USD)
				card.find('.default-price-net').val(net.toFixed(2));

				// 🔁 Also recalc second currencies NET (optional but recommended)
				let operator = currencyConversion.operator;
				let rate = parseFloat(currencyConversion.rate);

				card.find('.second-price').each(function () {

					let converted;

					if (operator === 'MUL') {
						converted = price * rate;
					} else if (operator === 'DIV') {
						converted = price / rate;
					} else {
						return;
					}

					$(this).val(converted.toFixed(2));
				});

				card.find('.second-price-net').each(function () {

					let converted;

					if (operator === 'MUL') {
						converted = net * rate;
					} else if (operator === 'DIV') {
						converted = net / rate;
					} else {
						return;
					}

					$(this).val(converted.toFixed(2));
				});

			});


			$(document).on('input', '.default-price-net', function () {

				let defaultNet = parseFloat($(this).val());
				if (isNaN(defaultNet)) return;

				let card = $(this).closest('.variation-card');

				let operator = currencyConversion.operator;
				let rate = parseFloat(currencyConversion.rate);

				card.find('.second-price-net').each(function () {

					let calculated;

					if (operator === 'MUL') {
						calculated = defaultNet * rate;
					} else if (operator === 'DIV') {
						calculated = defaultNet / rate;
					} else {
						return;
					}

					$(this).val(calculated.toFixed(2));
				});
			});

		const colorImagesBuffer = {};

		$(document).on('changed.bs.select', '#ProductColors', function () {

			let container   = $('#ColorVariationsContainer');
			let selectedIds = $(this).val() || [];
			let selectedSet = new Set(selectedIds.map(String));

			/* ==========================
			 * 1️⃣ REMOVE unselected cards
			 * ========================== */
			container.find('.color-card').each(function () {
				let colorId = String($(this).data('color-id'));
				if (!selectedSet.has(colorId)) {
					$(this).remove();
				}
			});

			/* ==========================
			 * 2️⃣ ADD missing cards
			 * ========================== */
			selectedIds.forEach(colorId => {

				if (container.find(`.color-card[data-color-id="${colorId}"]`).length)
					return;

				let opt       = $('#ProductColors option[value="' + colorId + '"]');
				let colorName = opt.data('name');
				let colorCode = opt.data('code');

				let html = `
			<div class="variation-card color-card" data-color-id="${colorId}">

			<!-- HEADER -->
			<div class="variation-header p-2 border-bottom" style="background-color:#ecebeb">
				<div class="container-fluid px-2">
					<div class="row align-items-center w-100">

						<div class="col-12 col-md-6">
							<div class="d-flex align-items-center">
								<div style="
									width:26px;
									height:26px;
									background-color:#${colorCode};
									border:1px solid #ccc;
									border-radius:4px;
									margin-right:10px;">
								</div>
								<strong>${colorName}</strong>
							</div>
						</div>

						<div class="col-12 col-md-6 text-md-right mt-2 mt-md-0">

								<input type="radio"
								   class="color-cover-radio"
								   name="CoverColorID"
								   value="${colorId}"
								   id="ColorCoverToggle_${colorId}">

							<label for="ColorCoverLabel_${colorId}">Is Cover</label>

							<!-- hidden for model binding -->
							<input id="ColorCover_${colorId}" type="hidden"
								   name="ProductColorsMeta[${colorId}].IsCover"
								   class="is-cover-hidden"
								   value="false">
								    
							<div class="custom-control custom-switch d-inline-block align-middle ml-3">
								<input type="checkbox"
									   class="custom-control-input"
									   id="ColorShowFront_${colorId}"
									   name="ProductColorsMeta[${colorId}].ShowFront"
									   checked>
								<label class="custom-control-label"
									   for="ColorShowFront_${colorId}">
									Show Front
								</label>
							</div>

							<div class="custom-control custom-switch d-inline-block align-middle ml-3">
								<input type="checkbox"
									   class="custom-control-input"
									   id="ColorActive_${colorId}"
									   name="ProductColorsMeta[${colorId}].IsActive"
									   checked>
								<label class="custom-control-label"
									   for="ColorActive_${colorId}">
									Active
								</label>
							</div>

						</div>



					</div>
				</div>
			</div>

			<!-- BODY -->
			<div class="variation-body p-3">
				<div class="row">

					<!-- IMAGE BOX -->
					<div class="col-12 col-md-2 text-center">
						<div style="width:200px; margin:auto;">

							<div class="image-box-wrapper position-relative"
								 style="width:200px; height:200px;">

								<div class="image-box border rounded bg-white shadow-sm
											d-flex align-items-center justify-content-center
											position-relative"
									 style="width:100%; height:100%; cursor:pointer;">

									<input type="file"
									   class="color-image-input"
									   data-color-id="${colorId}"
									   accept="image/*" 
										   style="opacity:0; position:absolute; width:100%; height:100%; cursor:pointer;">

									<span class="placeholder-icon text-muted" style="font-size:46px;">
										<i class="fas fa-image"></i>
									</span>

									<img class="color-image-preview d-none"
										 style="width:100%; height:100%; object-fit:contain;">
								</div>

								<!-- Overlay -->
								<div class="image-overlay d-flex flex-column justify-content-center align-items-center">
									<div class="d-flex gap-4">
										<button type="button" class="overlay-btn btn-clear" title="Clear">
											<i class="fas fa-times"></i>
										</button>
										<button type="button" class="overlay-btn btn-view" title="View">
											<i class="fas fa-eye"></i>
										</button>
										<button type="button" class="overlay-btn btn-browse" title="Browse">
											<i class="fas fa-paperclip"></i>
										</button>
									</div>
								</div>

							</div>

							<div class="text-center mt-2">
								<button type="button" class="btn btn-sm btn-primary w-100 btn-add-color-image">
									<i class="fas fa-plus"></i> Add Image
								</button>
							</div>

						</div>
					</div>

					<!-- IMAGE LIST -->
					<div class="col-12 col-md-10">
						<div id="dProductColorImagesList${colorId}" class="color-images-scroll p-2"></div>
					</div>

				</div>
			</div>

		</div>
				`;

				container.append(html);
			});
		});

		$(document).on('click', '.btn-add-color-image', function () {

			let $card   = $(this).closest('.color-card');
			let colorId = $card.data('color-id');
			let $list   = $('#dProductColorImagesList' + colorId);

			let files = colorImagesBuffer[colorId] || [];

			if (!files.length) {
				toastr.warning('Please browse images first');
				return;
			}

			if (!removedNewImages[colorId]) {
				removedNewImages[colorId] = new Set();
			}

			files.forEach(file => {

				let removedSet = removedNewImages[colorId];

				// 🔒 Prevent duplicates OR re-adding removed ones
				let exists =
					$list.find(`.color-image-item[data-filename="${file.name}"]`).length > 0 ||
					removedSet.has(file.name);

				if (exists) return;

				let reader = new FileReader();

				reader.onload = function (e) {

						let tempId = 'NEW_' + Math.random().toString(36).substring(2,9);

	let imageHtml = `
	<div class="inline-block">

		<div class="color-image-item position-relative"
			 style="min-width:200px;height:200px;"
			 data-filename="${file.name}"
			 data-temp-id="${tempId}">

			<img src="${e.target.result}"
				 class="img-fluid rounded"
				 style="width:100%;height:100%;object-fit:contain;background:#fff;border:1px solid #ccc;">

			<div class="image-overlay d-flex justify-content-center align-items-center">
				<button type="button" class="overlay-btn btn-view-image">
					<i class="fas fa-eye"></i>
				</button>
				<button type="button" class="overlay-btn btn-clear-image">
					<i class="fas fa-times"></i>
				</button>
			</div>
		</div>

		<div class="mt-1 text-center">
			<label class="mb-0">
				<input type="radio"
					   class="radio-initial"
					   name="ColorInitial_${colorId}">
				Is Initial
			</label>

			<input type="hidden"
				   name="ColorImageInitial[${colorId}][${tempId}]"
				   value="false"
				   class="initial-hidden">
		</div>

	</div>
	`;




					$list.append(imageHtml);
				};

				reader.readAsDataURL(file);
			});

			// ✅ RESET IMAGE BOX PREVIEW
			let $box = $card.find('.image-box');

			$box.find('.color-image-preview')
				.attr('src', '')
				.addClass('d-none');

			$box.find('.placeholder-icon').removeClass('d-none');
		});

		 // when selecting initial image per color


	$(document).on('change', '.color-image-input', function () {

		let input   = this;
		let $card   = $(this).closest('.color-card');
		let colorId = $card.data('color-id');

		if (!input.files || !input.files.length) return;

		let file = input.files[0];

		const maxSizeKB = 100;
		const maxSizeBytes = maxSizeKB * 1024;

		// ============================================
		// 🔴 SIZE VALIDATION FIRST (BEFORE BUFFER)
		// ============================================
		if (file.size > maxSizeBytes) {

			toastr.error("Image size must not exceed 100 KB");

			// 🔥 CLEAR BUFFER (IMPORTANT)
			if (colorImagesBuffer[colorId]) {
				colorImagesBuffer[colorId] = [];
			}

			// reset input
			input.value = "";

			// reset preview
			let $box = $card.find('.image-box');
			let $img = $box.find('.color-image-preview');
			let $icon = $box.find('.placeholder-icon');

			$img.attr('src','').addClass("d-none");
			$icon.removeClass("d-none");

			return;
		}

		// ============================================
		// 🟢 BUFFER FILE ONLY IF VALID
		// ============================================
		if (!colorImagesBuffer[colorId]) {
			colorImagesBuffer[colorId] = [];
		}

		colorImagesBuffer[colorId].push(file);

		// ============================================
		// 🟢 PREVIEW
		// ============================================
		let reader = new FileReader();

		reader.onload = function (e) {

			let $box = $card.find('.image-box');
			let $img = $box.find('.color-image-preview');
			let $icon = $box.find('.placeholder-icon');

			$img.attr('src', e.target.result).removeClass('d-none');
			$icon.addClass('d-none');
		};

		reader.readAsDataURL(file);

		// reset input (allow reselect same file)
		input.value = '';

		toastr.success('Image selected. Click "Add Image".');
	});

		$(document).on('click', '.btn-view-image', function (e) {

			e.preventDefault();
			e.stopPropagation();

			let $imageItem = $(this).closest('.color-image-item');
			let imgSrc = $imageItem.find('img').attr('src');

			if (!imgSrc) return;

			// 🔵 open preview modal or new tab
			showImagePreview(imgSrc);

		});

	function showImagePreview(src){

		let html = `
		<div class="modal fade" id="imagePreviewModal" tabindex="-1">
			<div class="modal-dialog modal-dialog-centered modal-lg">
				<div class="modal-content bg-dark">

					<div class="modal-header border-0">
						<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
					</div>

					<div class="modal-body text-center">
						<img src="${src}" style="max-width:100%; max-height:70vh; border-radius:10px;">
					</div>

				</div>
			</div>
		</div>`;

		$("#imagePreviewModal").remove();
		$("body").append(html);
		$("#imagePreviewModal").modal("show");
	}

		$(document).on('click', '.btn-clear-image', function (e) {

		e.preventDefault();
		e.stopPropagation();

		let $imageItem = $(this).closest('.color-image-item');
		let $card      = $(this).closest('.color-card');

		let colorId  = $card.data('color-id');
		let fileName = $imageItem.data('filename');
		let tempId   = $imageItem.data('temp-id');

		// =====================================
		// 🟥 Remove from UI
		// =====================================
		$imageItem.closest('.inline-block').remove();

		// =====================================
		// 🟥 Remove from buffer
		// =====================================
		if (colorImagesBuffer[colorId]) {
			colorImagesBuffer[colorId] =
				colorImagesBuffer[colorId].filter(f => f.name !== fileName);
		}

		// =====================================
		// 🟥 Prevent re-adding same file
		// =====================================
		if (!removedNewImages[colorId]) {
			removedNewImages[colorId] = new Set();
		}

		removedNewImages[colorId].add(fileName);

	});

		$(document).on('click', '.btn-clear', function (e) {

			e.preventDefault();
			e.stopPropagation();

			const $card   = $(this).closest('.color-card');
			const colorId = $card.data('color-id');

			// ============================================
			// 🟥 REMOVE ALL FILES FROM BUFFER (MAIN FIX)
			// ============================================
			if (colorImagesBuffer[colorId]) {
				colorImagesBuffer[colorId] = [];   // 🔥 EMPTY BUFFER
			}

			// ============================================
			// 🟥 CLEAR FILE INPUT
			// ============================================
			const $fileInput = $card.find('.color-image-input');
			$fileInput.val('');
			$fileInput.get(0).value = '';

			// ============================================
			// 🟥 REMOVE ALL THUMBNAILS
			// ============================================
			$card.find('.color-image-list').html('');

			// ============================================
			// 🟥 RESET PREVIEW
			// ============================================
			const $preview = $card.find('.color-image-preview');
			const $icon    = $card.find('.placeholder-icon');

			$preview.attr('src','').addClass('d-none');
			$icon.removeClass('d-none');

	});



		$(document).on('click', '.btn-browse', function (e) {
			e.preventDefault();
			e.stopPropagation();

			let $card = $(this).closest('.color-card');
			let $input = $card.find('.color-image-input').first();

			$input.trigger('click');
		});

			$(document).on('click', '.btn-view', function (e) {
		e.preventDefault();
		e.stopPropagation();

		let src = '';

		// image inside list
		if ($(this).closest('.color-image-item').length) {
			src = $(this).closest('.color-image-item').find('img').attr('src');
		}

		// image inside main preview box
		if (!src) {
			src = $(this)
				.closest('.image-box-wrapper')
				.find('.color-image-preview')
				.attr('src');
		}

		if (!src) return;

		$('#imageProductViewModalImg').attr('src', src);
		$('#imageProductViewModal').modal('show');
	});

		$(document).on('click', '.color-image-item img', function () {
		const src = $(this).attr('src');
		if (!src) return;

		$('#imageProductViewModalImg').attr('src', src);
		$('#imageProductViewModal').modal('show');
	});
	 
	const removedNewImages = {}; // { colorId: Set(filenames) }
 
	$(document).on("click", "#btnSaveProductInitialInfo", function () {

		// ==================================================
		// 🔥 FORCE bootstrap-select → real <select> values
		// ==================================================
		$('.product-sizes').each(function () {
			const selected = $(this).selectpicker('val');
			if (selected && selected.length > 0) {
				$(this).val(selected);
			}
		});

		$('.product-details').each(function () {
			const selected = $(this).selectpicker('val');
			if (selected && selected.length > 0) {
				$(this).val(selected);
			}
		});

		$('#ProductSpecs').val($('#ProductSpecs').selectpicker('val'));
		$('#ProductTypes').val($('#ProductTypes').selectpicker('val'));
		$('#ProductColors').val($('#ProductColors').selectpicker('val'));
		$('#ProductSubCategory').val($('#ProductSubCategory').selectpicker('val'));

		// ==================================================
		// Elements
		// ==================================================
		let btn     = $(this);
		let spinner = $("#btnSaveProductInitialInfoSpinner");
		let form    = $("#productForm");

		// ==================================================
		// Reset validation
		// ==================================================
		$("#ProductCodeMessage").text("");
		$("#ProductNameMessage").text("");
		$("#ProductSubCategoryMessage").text("");  

		let hasError = false;

		// ==================================================
		// Validation
		// ==================================================
		if (!$("#ProductCode").val().trim()) {
			$("#ProductCodeMessage").text("Product code is required");
			hasError = true;
		}

		if (!$("#ProductName").val().trim()) {
			$("#ProductNameMessage").text("Product name is required");
			hasError = true;
		}

		let subCategories = $("#ProductSubCategory").val();
		if (!subCategories || subCategories.length === 0) {
			$("#ProductSubCategoryMessage")
				.text("Please select at least one sub category");
			hasError = true;
		}

		let specs = $("#ProductSpecs").val();
		
		if (!specs || specs.length === 0) {
			 
			$("#ProductSpecsMessage").text("Please select at least one spec");
			hasError = true;
		}

 
		let colors = $("#ProductColors").val();
		if (!colors || colors.length === 0) {
			$("#ProductColors")
				.closest(".col-12")
				.append(`
					<div id="ProductColorsMessage"
						 class="text-danger fw-normal mt-1">
						 Please select at least one color
					</div>
				`);
			toastr.error("Please at lease one color")
			hasError = true;
		}

		

		if (hasError){
			toastr.error("Please fill or select the required field!");
			return;
		}

		 

		// ==================================================
		// Submit
		// ==================================================
		btn.prop("disabled", true);
		spinner.removeClass("d-none");

		let formData = new FormData(form[0]);

		// ==================================================
		// 🔥 Append NEW color images
		// ==================================================
		Object.keys(colorImagesBuffer).forEach(colorId => {

			let files = colorImagesBuffer[colorId] || [];
			let removedSet = removedNewImages[colorId] || new Set();

			files.forEach(file => {
				if (removedSet.has(file.name)) return;

				formData.append(
					`ProductColorImages[${colorId}][]`,
					file
				);
			});
		});

		// ==================================================
		// 🔥 Keep EXISTING images
		// ==================================================
		$('.color-image-item[data-image-id]').each(function () {
			formData.append(
				'KeptImageIds[]',
				$(this).data('image-id')
			);
		});

	// ==================================================
	// 🔥 Append INITIAL flags per image
	// ==================================================
	// $('.initial-hidden').each(function () {

	// 	let name = $(this).attr('name');   ColorImageInitial[5][]
	// 	let val  = $(this).val();          true / false

	// 	formData.append(name, val);
	// });

		// ==================================================
		// AJAX
		// ==================================================
		$.ajax({
			url: '@Url.Action("SaveProduct", "Products")',
			type: 'POST',
			data: formData,
			processData: false,
			contentType: false,

			success: function (res) {

				if (res.success) {

			 
						
					// clear image buffers
					Object.keys(colorImagesBuffer).forEach(k => {
						colorImagesBuffer[k] = [];
					});

				

					$('#ProductID').val(res.productID);

					toastr.success("Product saved successfully");

					//$("#saveProductModal").modal("hide");
					//$("#tableProducts").DataTable().ajax.reload(null, false);

					//window.location.reload();

					$("#productDetails").removeClass("d-none");

					listProductPrice(res.productID);
					listProductStock(res.productID);
				

				} else {
					toastr.error(res.message || "Failed to save product");
				}
			},

			error: function () {
				toastr.error("Unexpected server error");
			},

			complete: function () {
				btn.prop("disabled", false);
				spinner.addClass("d-none");
			}
		});
	});



		function listProductPrice(ProductID){

			if (!ProductID) return;

			$.ajax({
				url: '@Url.Action("GetProductSizesPrice", "Products")',
				type: 'GET',
				data: { ProductID: ProductID },

				success: function (res){

					if (!res || !res.success){
						toastr.error(res.message || "Failed loading prices");
						return;
					}

					let html = "";

					res.data.forEach(size => {

						let baseKey = `${size.productTypeID}_${size.productDetailID}_${size.sizeID}`;

						html += `
						<div class="variation-card mb-2">

							<div class="variation-header p-2 bg-light d-flex justify-content-between align-items-center">
								<div>
									<span class="badge bg-primary me-1">${size.productTypeDescription}</span>
									<i class="fas fa-arrow-right text-muted mx-1"></i>
									<span class="badge bg-info me-1">${size.productDetailDescription}</span>
									<i class="fas fa-arrow-right text-muted mx-1"></i>
									<span class="badge bg-success">${size.sizeDescription}</span>
								</div>

								<div>
									<span class="text-muted small">Rank: ${size.sizeRank}</span>
								</div>
							</div>

							<div class="variation-body p-2">
						`;

						// ======================
						// GROUP BY COLOR
						// ======================
						let colorGroups = {};

						(size.productSizePrice || []).forEach(p => {

							if (!colorGroups[p.colorID]){
								colorGroups[p.colorID] = {
									colorName: p.colorName,
									colorCode: p.colorCode,
									prices: []
								};
							}

							colorGroups[p.colorID].prices.push(p);
						});

						// ======================
						// COLOR ROWS
						// ======================
						Object.keys(colorGroups).forEach(colorID => {

							let color = colorGroups[colorID];

							color.prices.forEach(price => {

								let key = `${price.productTypeID}_${price.productDetailID}_${price.sizeID}_${price.colorID}_${price.currencyID}`;

								html += `<div class="row align-items-end mb-2 border-top pt-2">`;

								// COLOR
								html += `
									<div class="col-md-3">
										<label>Color</label>
										<div>
											<i class="fas fa-square me-1" style="color:#${color.colorCode}"></i>
											${color.colorName}
										</div>
									</div>
								`;

								// SALE (PER PRICE)
								html += `
									<div class="col-md-2">
										<label>Sale %</label>
										<input type="number" step="0.01"
											class="form-control form-control-sm sale-input"
											name="Sale[${key}]"
											data-key="${key}"
											value="${price.sale ?? 0}" ${price.useInPrice === false ? 'disabled' : ''}>
									</div>
								`;

								// AMOUNT
								html += `
									<div class="col-md-3">
										<label>Amount (${price.currencyCode})</label>
										<input type="number" step="0.01"
											class="form-control form-control-sm price-input"
											name="Price[${key}]"
											data-key="${key}"
											data-currency="${price.currencyID}"
											value="${price.amount}" ${price.useInPrice === false ? 'disabled' : ''}>
									</div>
								`;

								// NET
								html += `
									<div class="col-md-3">
										<label>Net (${price.currencyCode})</label>
										<input type="number" step="0.01"
											class="form-control form-control-sm price-net-input"
												name="PriceNet[${key}]"
											data-key="${key}"
											data-currency="${price.currencyID}"
											value="${price.amountNet}" ${price.useInPrice === false ? 'disabled' : ''}>
									</div>`;

									 html += `
											<div class="col-md-1">

												<label class="font-weight-bold d-block">Used</label>

												<input type="hidden"
													   name="PriceInUse[${key}]"
													   value="${price.useInPrice === true ? 'true' : 'false'}"
													   class="price-hidden"
													   data-key="${key}">

												<div class="custom-control custom-switch">
														<input type="checkbox" ${price.useInPrice === true ? 'checked' : ''}
														   class="custom-control-input useinprice"
														   id="use_${key}"
														   data-key="${key}">
													<label class="custom-control-label" for="use_${key}"></label>
												</div>

											</div>
										`;

								html += `<input type="hidden"
								name="CountryID[${key}]"
								value="${price.countryID}" />`

								html += `</div>`;
							});

						});

						html += `</div></div>`;
					});

					$("#ProductSizesPrices").html(html);
				},

				error:function(){
					toastr.error("Server error loading prices");
				}
			});

		}
		 
		$(document).on("click", "#btnCancelProduct, #btnCloseProduct", function () {

			window.location.reload();

		});

				// Open Size Entry
				$('#btnNewSize').on('click', function () {
					$('#SizeEntry').stop(true, true).slideDown(300);
					$('#txtSizeDescription').val('').focus();
				});

				$('#btnCancelSize').on('click', function () {
					$('#SizeEntry').stop(true, true).slideUp(300);
				});
		
			$('#btnCreateSize').on('click', function () {

				const $input = $('#txtSizeDescription');
				const description = $input.val().trim();

				// 🔴 Client-side required validation
				if (!description) {
					$input.addClass('border-danger');
					toastr.warning('Size description is required.');
					$input.focus();
					return;
				}

				// Clear validation
				$input.removeClass('border-danger');

				const $btn = $('#btnCreateSize');
				const $spinner = $('#btnCreateSizeSpinner');
				const $icon = $('#btnCreateSize i');

				// 🔄 Show spinner
				$spinner.removeClass('d-none');
				$icon.addClass('d-none');
				$btn.prop('disabled', true);

				// ✅ AJAX
				$.ajax({
					url: '@Url.Action("CreateSize", "Products")',
					type: 'POST',
					data: { Description: description },
					success: function (res) {

						if (!res.success) {
							toastr.error(res.message || 'Failed to create size.');
							return;
						}

						// Add new size and select it
						$('#ProductSizes').append(
							`<option value="${res.data.id}" selected>
								${res.data.description}
							 </option>`
						);

						$('#ProductSizes').selectpicker('destroy').selectpicker('render').trigger('changed.bs.select');

						// Close entry smoothly
						$('#SizeEntry').slideUp(300);
						$input.val('');

						toastr.success('Size created successfully!');
					},
					error: function () {
						toastr.error('Server error while creating size.');
					},
					complete: function () {
						// 🔄 Restore button
						$spinner.addClass('d-none');
						$icon.removeClass('d-none');
						$btn.prop('disabled', false);
					}
				});
			});

			$('#txtSizeDescription').on('input', function () {
				$(this).removeClass('border-danger');
			});
	 
				// 🔹 Open Color Entry
				// Open slowly
			$('#btnNewColor').on('click', function () {

				$('#ColorEntry').stop(true, true).slideDown(300); // same speed as size

				// Reset fields
				$('#ColorID').val(0);
				$('#ColorName').val('');
				$('#ColorNameMessage').text('');
				$('#ColorCodeMessage').text('');

				// Reset toggles
				$('#ColorIsCustomToggle').prop('checked', false);
				$('#ColorStatusToggle').prop('checked', true);
				$('#ColorStatusLabel').text('Active');
				$('#ColorStatusID').val('A');

				// Reset picker
				$('#ColorPicker').prop('disabled', false).val('#000000');
				$('#ColorCode').val('#000000');

				$('#ColorName').focus();
			});


			// Close slowly
			$('#btnCancelColor').on('click', function () {
				$('#ColorEntry').stop(true, true).slideUp(300); // same speed as size
			});

			$('#txtSizeDescription').on('keypress', function (e) {
				if (e.which === 13) {
					$('#btnCreateSize').click();
				}
			});

				$('#btnCreateColor').on('click', function () {

					let hasError = false;

					const $btn = $('#btnCreateColor');
					const $spinner = $('#btnCreateColorSpinner');
					const $icon = $('#btnCreateColor i');

					const name = $('#ColorName').val().trim();
					const isCustom = $('#ColorIsCustomToggle').is(':checked');
					const code = isCustom ? null : $('#ColorCode').val();
					const statusID = $('#ColorStatusToggle').is(':checked') ? 'A' : 'I';

					// Reset validation
					$('#ColorNameMessage').text('');
					$('#ColorCodeMessage').text('');
					$('#ColorName').removeClass('border-danger');

					// 🔴 Client-side validation
					if (!name) {
						$('#ColorNameMessage').text('Color name is required.');
						$('#ColorName').addClass('border-danger');
						hasError = true;
					}

					if (!isCustom && !code) {
						$('#ColorCodeMessage').text('Color code is required.');
						hasError = true;
					}

					if (hasError) {
						return;
					}

					// 🔄 Show spinner
					$spinner.removeClass('d-none');
					$icon.addClass('d-none');
					$btn.prop('disabled', true);

					// ✅ AJAX
					$.ajax({
						url: '@Url.Action("CreateColor", "Products")',
						type: 'POST',
						data: {
							Name: name,
							Code: code,
							IsCustom: isCustom,
							StatusID: statusID
						},
						success: function (res) {

							if (res.exists) {
								$('#ColorNameMessage').text(res.message);
								$('#ColorName').addClass('border-danger');
								toastr.warning(res.message);
								return;
							}

							if (res.error || !res.success) {
								toastr.error(res.message || 'Failed to create color.');
								return;
							}

							const color = res.data;

							// Add to selectpicker and select it
							$('#ProductColors').append(`
								<option value="${color.id}"
										data-name="${color.name}"
										data-code="${color.code}"
										data-content='
											<span style="
												display:inline-block;
												width:14px;
												height:14px;
												background-color:${color.code ? '#' + color.code : 'transparent'};
												border:1px solid #ccc;
												margin-right:6px;
												vertical-align:middle;">
											</span>
											<span>${color.name}</span>
										'
										selected>
									${color.name}
								</option>
							`);

							$('#ProductColors').selectpicker('destroy').selectpicker('render').trigger('changed.bs.select');

							// Close entry smoothly
							$('#ColorEntry').slideUp(300);

							// Reset form
							$('#ColorName').val('');
							$('#ColorCode').val('');
							$('#ColorIsCustomToggle').prop('checked', false);

							toastr.success('Color created successfully!');
						},
						error: function () {
							toastr.error('Server error while creating color.');
						},
						complete: function () {
							// 🔄 Restore button
							$spinner.addClass('d-none');
							$icon.removeClass('d-none');
							$btn.prop('disabled', false);
						}
					});
				});

			$('#ColorName').on('input', function () {
				$(this).removeClass('border-danger');
				$('#ColorNameMessage').text('');
			});
 
	 
  


		$('#ProductExpiryDate').daterangepicker({  singleDatePicker: true,
		autoApply: true,
		showDropdowns: true,
		timePicker: false,
		locale: { format: 'YYYY-MM-DD' }});

		////////////////////////////////////////////////////////////////////////////////////////
		const productDetailsData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.productDetails));

		function generateDetailsOptions() {
		
		let html = '';

			productDetailsData.forEach(d => {
				html += `<option value="${d.ID}">${d.Description}</option>`;
			});
			return html;
		}

		////////////////////////////////////////////////////////////////////////////////////////
	$(document).on('changed.bs.select', '#ProductTypes', function () {

		const selectedValues = $(this).val() || [];

		// if tabs not exist create container
		if (!$('#productTypeTabs').length) {
			$('#productDetailsTabsContainer').html(`
				<ul class="nav nav-tabs" id="productTypeTabs"></ul>
				<div class="tab-content border border-top-0 p-3" id="productTypeTabContent"></div>
			`);
		}

		// ============================================
		// 🟢 ADD NEW TYPES ONLY (NO REFRESH OLD)
		// ============================================
		selectedValues.forEach((typeID, index) => {

			if ($('#tab-btn-' + typeID).length) return; // already exists

			const typeText = $('#ProductTypes option[value="' + typeID + '"]').text();

			const active = $('#productTypeTabs .nav-link.active').length === 0 ? 'active' : '';
			const show   = active ? 'show active' : '';

			// ===== TAB BUTTON
			$('#productTypeTabs').append(`
				<li class="nav-item">
					<button class="nav-link ${active}"
							id="tab-btn-${typeID}"
							data-bs-toggle="tab"
							data-bs-target="#type-${typeID}"
							type="button">
						${typeText}
					</button>
				</li>
			`);

			// ===== TAB CONTENT
			$('#productTypeTabContent').append(`
				<div class="tab-pane fade ${show}" id="type-${typeID}">

					<div class="row mb-3">
						<div class="col-12 col-md-6">
							<label>Details</label>

							<select class="form-control selectpicker product-details"
									name="ProductDetails[${typeID}][]"
									multiple
									data-live-search="true"
									data-actions-box="true">

								${generateDetailsOptions()}

							</select>
						</div>
					</div>

					<div id="productDetailsContainer${typeID}"></div>

				</div>
			`);

			// init only this selectpicker
			$('#type-' + typeID + ' .selectpicker').selectpicker();
		});

		// ============================================
		// 🔴 REMOVE UNSELECTED TYPES ONLY
		// ============================================
		$('#productTypeTabs .nav-link').each(function () {

			const btnId = $(this).attr('id'); // tab-btn-3
			const typeID = btnId.replace('tab-btn-', '');

			if (!selectedValues.includes(typeID)) {

				$(this).closest('li').remove();
				$('#type-' + typeID).remove();
			}
		});

		// ============================================
		// 🟢 ACTIVATE FIRST TAB IF NONE ACTIVE
		// ============================================
		if ($('#productTypeTabs .nav-link.active').length === 0) {
			$('#productTypeTabs .nav-link:first').addClass('active');
			$('#productTypeTabContent .tab-pane:first').addClass('show active');
		}

	});
	 
		////////////////////////////////////////////////////////////////////////////////////////

		const productSizesData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.sizes))

			function generateSizesOptions() {
				let html = '';
				productSizesData.forEach(s => {
					html += `<option value="${s.ID}">${s.Description}</option>`;
				});
				return html;
			}

					// =======================================================
		// DETAILS MULTI SELECT
		// =======================================================
	$(document).on('changed.bs.select', '.product-details', function () {

		const $select = $(this);
		const typeID = $select.attr('name').match(/\d+/)[0];
		const selectedDetails = $select.val() || [];
		const $container = $('#productDetailsContainer' + typeID);

			let detailsState = {};

	$('.product-details').each(function () {
		let name = $(this).attr('name');   // ProductDetails[1][]
		detailsState[name] = $(this).val() || [];
	});

		// ==========================================
		// 🟥 REMOVE ONLY UNSELECTED
		// ==========================================
		$container.find('.detail-block').each(function () {

			const detailId = String($(this).data('detail-id'));

			if (!selectedDetails.includes(detailId)) {

				// destroy selectpicker inside before remove
				$(this).find('.selectpicker').selectpicker('destroy');

				$(this).remove();
			}
		});

		// ==========================================
		// 🟩 ADD ONLY NEW DETAILS (NO REFRESH OLD)
		// ==========================================
		selectedDetails.forEach(detailId => {

			// if already exists → DO NOTHING
			if ($container.find(`.detail-block[data-detail-id="${detailId}"]`).length)
				return;

			const detailText = $select.find(`option[value="${detailId}"]`).text();

			const html = `
			<div class="detail-block variation-card mt-2"
				 data-detail-id="${detailId}">

				<div class="variation-header px-3 py-2 bg-light">
					<b>${detailText}</b>
				</div>

				<div class="variation-body p-3">

					<div class="row mb-3">
						<div class="col-md-12">

							<label>Sizes</label>

							<select class="form-control selectpicker product-sizes"
									name="ProductSizes[${typeID}][${detailId}][]"
									multiple
									data-live-search="true"
									data-actions-box="true">

								${generateSizesOptions()}

							</select>

						</div>
					</div>

					<div class="size-variations"
						 id="sizeVariations_${typeID}_${detailId}">
					</div>

				</div>
			</div>
			`;

			$container.append(html);

			// init ONLY this new picker
			$container
				.find(`.detail-block[data-detail-id="${detailId}"] .selectpicker`)
				.selectpicker();
		});

	});

	$(document).on("click", "#btnSaveProductPrice", function (e) {

		e.preventDefault();

		let btn = $("#btnSaveProductPrice");
		let spinner = $("#btnSaveProductPriceSpinner");

		// disable button + show spinner
		btn.prop("disabled", true);
		spinner.removeClass("d-none");

		let formData = new FormData(document.getElementById("productForm"));

		$.ajax({
			url: '@Url.Action("SavePrice", "Products")',
			type: "POST",
			data: formData,
			processData: false,
			contentType: false,

			success: function (res) {

				btn.prop("disabled", false);
				spinner.addClass("d-none");

				if (res && res.success) {
					toastr.success(res.message || "Prices saved successfully");

					// optional reload prices after save
					// loadProductPrice($("#ProductID").val());
				}
				else {
					toastr.error(res.message || "Error saving prices");
				}
			},

			error: function (xhr) {

				btn.prop("disabled", false);
				spinner.addClass("d-none");

				toastr.error("Server error while saving");
				console.log(xhr.responseText);
			}
		});
	});

	$(document).on("click", "#btnSaveProductStock", function () {

	let btn = $("#btnSaveProductStock");
	let spinner = $("#btnSaveProductStockSpinner");

	// =========================================
	// 🛑 PREVENT DOUBLE CLICK
	// =========================================
	if (btn.data("loading")) return;
	btn.data("loading", true);

	// =========================================
	// 🔵 CHECK DUPLICATE BARCODE INSIDE PAGE
	// =========================================
	let barcodeMap = {};
	let hasDuplicate = false;

	$(".barcode").each(function () {

		let input = $(this);
		let value = input.val().trim();

		input.removeClass("border-danger");

		if (!value) return;

		if (barcodeMap[value]) {
			input.addClass("border-danger");
			barcodeMap[value].addClass("border-danger");
			hasDuplicate = true;
		} else {
			barcodeMap[value] = input;
		}
	});

	if (hasDuplicate) {
		toastr.error("Duplicate barcode exists in table");
		btn.data("loading", false);
		return;
	}

	// =========================================
	// 🔵 PREPARE FORM DATA
	// =========================================
	btn.prop("disabled", true);
	spinner.removeClass("d-none");

	let formData = new FormData();
	formData.append("ProductID", $("#ProductID").val());

	let index = 0;

	$("#ProductStock tbody tr").each(function () {

		let row = $(this);

		let sizeId = row.find(".size-id").val();
		let colorId = row.find(".color-id").val();
		let typeId = row.find(".type-id").val() || 0;
		let detailId = row.find(".detail-id").val() || 0;
		let qty = row.find(".qty").val() || 0;
		let barcode = row.find(".barcode").val() || "";
		let stockInUse = row.find('.useinstock').is(':checked') ? 1 : 0;

		formData.append(`StockSizeID[${index}]`, sizeId);
		formData.append(`StockColorID[${index}]`, colorId);
		formData.append(`StockTypeID[${index}]`, typeId);
		formData.append(`StockDetailID[${index}]`, detailId);
		formData.append(`StockQty[${index}]`, qty);
		formData.append(`StockBarcode[${index}]`, barcode);
		formData.append(`StockInUse[${index}]`, stockInUse);

		index++;
	});

	// =========================================
	// 🔵 AJAX SAVE
	// =========================================
	$.ajax({
		url: '@Url.Action("SaveStock", "Products")',
		type: "POST",
		data: formData,
		processData: false,
		contentType: false,

		success: function (res) {

			btn.prop("disabled", false);
			spinner.addClass("d-none");
			btn.data("loading", false);

			if (res.success) {
				toastr.success("Stock saved successfully");
				listProductStock($("#ProductID").val());
			}
			else {
				toastr.error(res.message || "Error saving");

				// 🔴 highlight barcode from backend message
				if (res.message && res.message.includes("Barcode")) {
					let barcode = res.message.split(":")[1]?.trim();

					$(".barcode").each(function () {
						if ($(this).val() === barcode) {
							$(this).addClass("border-danger");
							$('html,body').animate({
								scrollTop: $(this).offset().top - 150
							}, 400);
						}
					});
				}
			}
		},

		error: function () {

			btn.prop("disabled", false);
			spinner.addClass("d-none");
			btn.data("loading", false);

			toastr.error("Server error while saving");
		}
	});

	});



		function listProductStock(ProductID){

			if (!ProductID) return;

			$.ajax({
				url: '@Url.Action("GetProductStock", "Products")',
				type: 'GET',
				data: { productId: ProductID },

					success: function(res){

		if(!res.success){
			toastr.error(res.message);
			return;
		}

		let html = "";

		// 🔵 LOOP SIZES
		res.productSizes.forEach(size => {

			html += `
			<div class="variation-card mb-3">

				<div class="variation-header p-2 bg-light">
					<span class="text-primary font-weight-bold">${size.sizeDescription}</span> -
					<span class="text-muted font-italic">Rank: ${size.sizeRank}</span>
				</div>

				<div class="variation-body p-2">
				<table class="table table-sm table-bordered">
				<thead class="bg-light">
					<tr>
						<th style="width:200px">Color</th>
						<th style="width:150px">Type</th>
						<th style="width:150px">Detail</th>
						<th style="width:100px">Qty</th>
						<th style="width:160px">Barcode</th>
						<th style="width:50px">Used</th>
					</tr>
				</thead>
				<tbody>
			`;

			// 🔵 DETAILS FOR THIS SIZE
			let details = res.sizeDetails.filter(d => d.sizeID == size.sizeID);

			details.forEach(det => {

				// 🔵 LOOP COLORS
				res.colors.forEach(color => {

					let stock = res.stocks.find(x =>
						x.sizeID == size.sizeID &&
						x.colorID == color.colorID &&
						x.productTypeID == det.productTypeID &&
						x.productDetailID == det.productDetailID
					);

					if(!stock){
						stock = {
							id:0,
							quantity:0,
							barcode:""
						};
					}

					html += `
					<tr>

						<td class="align-middle">
							<i class="fas fa-square"
							   style="color:#${color.code}; font-size:18px"></i>
							${color.name}

							<input type="hidden" class="stock-id" value="${stock.id}">
							<input type="hidden" class="size-id" value="${size.sizeID}">
							<input type="hidden" class="color-id" value="${color.colorID}">
							<input type="hidden" class="type-id" value="${det.productTypeID}">
							<input type="hidden" class="detail-id" value="${det.productDetailID}">
						</td>

						<td class="align-middle">${det.productTypeDescription}</td>
						<td class="align-middle">${det.productDetailDescription}</td>

						<td>
							<input type="number"
								   class="form-control form-control-sm qty" min="0"
								   value="${stock.quantity}"
								   ${!stock.useInStock ? 'disabled' : ''}>
						</td>

						<td>
							<input type="text"
								   class="form-control form-control-sm barcode"
								   value="${stock.barcode ?? ''}"
								   ${!stock.useInStock ? 'disabled' : ''}>
						</td>

						<td class="align-middle text-center">
							  <div class="custom-control custom-switch d-inline-block">
								<input type="checkbox"
									   class="custom-control-input useinstock"
									   id="stock_${stock.id}"
									   ${stock.useInStock ? 'checked' : ''}
									   ${stock.quantity > 0 ? 'disabled' : ''}>
								<label class="custom-control-label" for="stock_${stock.id}"></label>
							</div>
						</td>

					</tr>`;
				});

			});

			html += `</tbody></table></div></div>`;
		});

		$("#ProductStock").html(html);
	}

			});
		}



	});


</script>
