<!-- ========================= -->
<!-- 🔹 Generic Rank Modal -->
<!-- ========================= -->
<div class="modal fade" id="rankModal" role="dialog" aria-labelledby="rankModalTitle" aria-hidden="true" style="z-index:2000">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
        <div class="modal-content shadow-sm">

            <!-- Header -->
            <div class="modal-header py-2">
                <h5 class="modal-title font-weight-bold" id="rankModalTitle">
                    <i class="fa fa-sort-numeric-down mr-2 text-primary"></i>
                    Set Rank
                </h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <!-- Body -->
            <div class="modal-body">

                <!-- Rank List -->
                <select id="rankSelect"
                        class="form-control form-control-sm"
                        size="10">
                </select>

                <!-- Up / Down -->
                <div class="d-flex mt-3">
                    <button type="button"
                            id="rankUp"
                            class="btn btn-outline-secondary btn-sm flex-fill mr-2">
                        <i class="fa fa-arrow-up"></i> Up
                    </button>

                    <button type="button"
                            id="rankDown"
                            class="btn btn-outline-secondary btn-sm flex-fill">
                        <i class="fa fa-arrow-down"></i> Down
                    </button>
                </div>

            </div>

            <!-- Footer -->
            <div class="modal-footer py-2">
                <button id="btnCancelRank" type="button"
                        class="btn btn-secondary btn-sm"
                        data-bs-dismiss="modal">
                  <i class="fas fa-ban"></i> Cancel
                </button>

                <button type="button"
                        id="btnSaveRank"
                        class="btn btn-primary btn-sm" style="width:100px">
                    <span class="save-text"> <i class="fas fa-save"></i> Save</span>
                    <span class="save-spinner d-none ms-2">
                        <span class="spinner-border spinner-border-sm" role="status"></span>
                    </span>
                </button>
            </div>

            <input id="rankMode" type="hidden" name="rankMode" value="" />

        </div>
    </div>
</div>

<script>

    document.addEventListener('DOMContentLoaded', function () {

    $('#rankUp').click(function () {
        const $selected = $('#rankSelect option:selected');
        $selected.each(function () {
            const $prev = $(this).prev();
            if ($prev.length) $(this).insertBefore($prev);
        });
        refreshRankNumbers();
    });

    $('#rankDown').click(function () {
        const $selected = $('#rankSelect option:selected');
        $($selected.get().reverse()).each(function () {
            const $next = $(this).next();
            if ($next.length) $(this).insertAfter($next);
        });
        refreshRankNumbers();
    });

    function refreshRankNumbers() {
        $('#rankSelect option').each(function (index) {
            const text = $(this).text().replace(/^\d+\.\s*/, '');
            $(this).text(`${index + 1}. ${text}`);
        });
    }


    $(document).on('click', '#btnSaveRank', function () {

        const mode = $('#rankMode').val();
        const CategoryID = $("#ParentCategoryID").val();

        switch (mode) {
            case "CTGRY":
                SaveRankCategory();
                break;

            case "SBCTGRY":
             
                SaveRankSubCategory(CategoryID);
                break;

            case "BRD":
                SaveRankGroup(mode);
                break;

            case "CLC": 
                SaveRankGroup(mode)
                break;

            case "PRDCT":
                SaveRankProduct();
                break;

            default:
                toastr.error('Invalid rank mode');
        }
    });

    function ShowSaveSpinner() {
        $('#btnSaveRank').prop('disabled', true);
        $('#btnSaveRank .save-text').text('Saving...');
        $('#btnSaveRank .save-spinner').removeClass('d-none');
    }

    function HideSaveSpinner() {
        $('#btnSaveRank').prop('disabled', false);
        $('#btnSaveRank .save-text').html('<i class="fas fa-save"></i> Save');
        $('#btnSaveRank .save-spinner').addClass('d-none');
    }

    function SaveRankCategory() {

        const ranks = [];

        $('#rankSelect option').each(function (index) {
            ranks.push({
                ID: $(this).val(),
                Rank: index + 1
            });
        });

        ShowSaveSpinner();

        $.ajax({
            url: '@Url.Action("SaveRankCategories", "Categories")',
            type: 'POST',
            contentType: 'application/json; charset=utf-8',
            data: JSON.stringify(ranks),
            success: function (res) {

                const table = $.fn.DataTable.isDataTable("#tableCategories")
                    ? $("#tableCategories").DataTable()
                    : null;

                if (!res.success) {
                    toastr.error(res.message || 'Failed to save category rank');
                    HideSaveSpinner();
                    return;
                }

                toastr.success(res.message || 'Category ranking saved');

                // Close modal
                const modalEl = document.getElementById('rankModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                if (table) table.ajax.reload(null, false);
               

                HideSaveSpinner();
            },
            error: function () {
                toastr.error('Server error while saving category rank');
                HideSaveSpinner();
            }
        });

    }

        function SaveRankGroup(TypeID) {

            const ranks = [];

            $('#rankSelect option').each(function (index) {
                ranks.push({
                    ID: $(this).val(),
                    Rank: index + 1
                });
            });

            ShowSaveSpinner();

            $.ajax({
                url: '@Url.Action("SaveRankGroups", "Groups")?Type=' + TypeID,
                type: 'POST',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(ranks),
                success: function (res) {

                    const table = $.fn.DataTable.isDataTable("#tableGroups")
                        ? $("#tableGroups").DataTable()
                        : null;

                    if (!res.success) {
                        toastr.error(res.message || 'Failed to save gourp rank');
                        HideSaveSpinner();
                        return;
                    }

                    toastr.success(res.message || 'Group ranking saved');

                    // Close modal
                    const modalEl = document.getElementById('rankModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                    if (table) table.ajax.reload(null, false);
                 
                    HideSaveSpinner();
                },
                error: function () {
                    toastr.error('Server error while saving group rank');
                    HideSaveSpinner();
                }
            });
        }

        function SaveRankSubCategory(CategoryID){

            const ranks = [];

            $('#rankSelect option').each(function (index) {
                ranks.push({
                    ID: $(this).val(),
                    Rank: index + 1
                });
            });

            ShowSaveSpinner();
             
            $.ajax({
                url: '@Url.Action("SaveRankSubCategories", "Categories")?CategoryID=' + CategoryID,
                type: 'POST',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(ranks),
                success: function (res) {

                    const table = $.fn.DataTable.isDataTable("#tableSubCategories")
                        ? $("#tableSubCategories").DataTable()
                        : null;

                    if (!res.success) {
                        toastr.error(res.message || 'Failed to save sub category rank');
                        HideSaveSpinner();
                        return;
                    }

                    toastr.success(res.message || 'Sub Category ranking saved');

                    // Close modal
                    const modalEl = document.getElementById('rankModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                    if (table) table.ajax.reload(null, false);


                    HideSaveSpinner();
                },
                error: function () {
                    toastr.error('Server error while saving sub category rank');
                    HideSaveSpinner();
                }
            });

        }

    });

</script>
